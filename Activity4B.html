<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity 4B - eMi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #191919;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
            padding: 0;
            opacity: 1;
            transition: opacity 0.15s ease;
        }

        body.fade-start {
            opacity: 0;
        }

        body.fade-out {
            opacity: 0;
        }

        .activity-page {
            width: 100vw;
            height: 100vh;
            padding: 8px;
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .sidebar {
            width: 80px;
            flex: 0 0 auto;
            height: 100%;
            background: linear-gradient(180deg, rgba(37, 41, 45, 1) 0%, rgba(63, 73, 82, 1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 0;
        }

        .logo-image {
            width: 80px;
            height: 80px;
            display: block;
            object-fit: contain;
        }

        .back-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 24px auto;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s;
            background-color: rgba(0, 0, 0, 0.2);
        }

        .back-button:hover {
            background-color: #191919;
        }

        .back-button:active {
            background-color: #191919;
            border: 1px solid #F8CB16;
            transform: scale(0.97);
        }

        .back-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            display: block;
        }

        .toolbar-actions {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
        }

        .tool-action {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s;
            background-color: rgba(0, 0, 0, 0.2);
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-weight: 700;
            font-size: 18px;
            color: #FFFFFF;
            line-height: 1;
        }

        .tool-action.active {
            background-color: #191919;
            border: 1px solid #F8CB16;
        }

        .tool-action:hover {
            background-color: #191919;
        }

        .tool-action:active {
            background-color: #191919;
            border: 1px solid #F8CB16;
            transform: scale(0.97);
        }

        .main-panel {
            flex: 2;
            min-width: 300px;
            height: 100%;
            background-color: #FFFFFF;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            display: flex;
            position: relative;
            box-sizing: border-box;
        }

        .forest-bg {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            border-radius: inherit;
            display: block;
        }

        .toy-stage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* Toy styling - adjust positions to match Figma */
        .toy {
            position: absolute;
            width: 120px;
            height: 120px;
            cursor: grab;
            pointer-events: auto;
            user-select: none;
            transition: opacity 0.2s;
        }

        .toy img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .toy.dragging {
            cursor: grabbing;
            animation: none !important;
            z-index: 1000;
            opacity: 0.9;
        }

        .toy.frozen {
            animation: none !important;
            cursor: default;
            pointer-events: none;
        }

        .toy.hidden {
            display: none;
        }

        .toy.disabled {
            pointer-events: none;
            cursor: default;
        }

        /* Floating animation for toys - gentle vertical bob */
        .toy.float {
            animation: floatToy 3.5s ease-in-out infinite;
        }

        .toy.float-delay-1 {
            animation: floatToy 3.8s ease-in-out infinite;
            animation-delay: 0.3s;
        }

        .toy.float-delay-2 {
            animation: floatToy 4.1s ease-in-out infinite;
            animation-delay: 0.6s;
        }

        .toy.float-delay-3 {
            animation: floatToy 3.6s ease-in-out infinite;
            animation-delay: 0.9s;
        }

        @keyframes floatToy {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-6px);
            }
            100% {
                transform: translateY(0);
            }
        }

        /* Placeholder positions - ADJUST THESE TO MATCH FIGMA */
        .toy.toy-bear {
            top: 15%;
            left: 10%;
        }

        .toy.toy-drum {
            top: 15%;
            left: 30%;
        }

        .toy.toy-plane {
            top: 15%;
            left: 50%;
        }

        .toy.toy-ball {
            top: 15%;
            left: 70%;
        }

        /* Box container - ADJUST POSITION TO MATCH FIGMA */
        .box-container {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 300px;
            pointer-events: auto;
        }

        .box-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            transition: opacity 0.3s;
        }

        .box-image.hidden {
            display: none;
        }

        .box-container.impact .box-image {
            animation: boxImpact 0.25s ease-out;
        }

        @keyframes boxImpact {
            0% {
                transform: scale(1);
                filter: brightness(1);
            }
            20% {
                transform: scale(1.08);
                filter: brightness(1.3);
            }
            40% {
                transform: scale(1.12);
                filter: brightness(1.5);
            }
            60% {
                transform: scale(1.08);
                filter: brightness(1.3);
            }
            100% {
                transform: scale(1);
                filter: brightness(1);
            }
        }

        .toy-in-box {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .toy-in-box.visible {
            opacity: 1;
        }

        .sparkle-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
        }

        .sparkle-layer::before,
        .sparkle-layer::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 200, 0.8) 30%, rgba(255, 255, 255, 0) 70%);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.9), 0 0 30px rgba(255, 255, 200, 0.6);
        }

        .sparkle-layer::before {
            top: 20%;
            left: 30%;
        }

        .sparkle-layer::after {
            top: 60%;
            right: 25%;
        }

        .sparkle-layer.sparkle-active {
            animation: sparkle 1s ease-out;
        }

        .sparkle-layer.sparkle-active::before {
            animation: sparklePulse 1s ease-out;
        }

        .sparkle-layer.sparkle-active::after {
            animation: sparklePulse 1s ease-out 0.15s;
        }

        .sparkle-layer .sparkle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 150, 0.9) 25%, rgba(255, 255, 255, 0) 65%);
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(255, 255, 255, 1), 0 0 24px rgba(255, 255, 200, 0.8), 0 0 36px rgba(255, 255, 150, 0.4);
            opacity: 0;
        }

        .sparkle-layer.sparkle-active .sparkle-1 {
            top: 15%;
            left: 25%;
            animation: sparklePulse 1s ease-out 0.1s;
        }

        .sparkle-layer.sparkle-active .sparkle-2 {
            top: 35%;
            right: 20%;
            animation: sparklePulse 1s ease-out 0.2s;
        }

        .sparkle-layer.sparkle-active .sparkle-3 {
            bottom: 30%;
            left: 35%;
            animation: sparklePulse 1s ease-out 0.3s;
        }

        .sparkle-layer.sparkle-active .sparkle-4 {
            top: 50%;
            right: 30%;
            animation: sparklePulse 1s ease-out 0.25s;
        }

        @keyframes sparkle {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            30% {
                opacity: 1;
                transform: scale(1.2);
            }
            60% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(1.5);
            }
        }

        @keyframes sparklePulse {
            0% {
                opacity: 0;
                transform: scale(0.3) rotate(0deg);
                filter: brightness(1);
            }
            25% {
                opacity: 1;
                transform: scale(1.3) rotate(90deg);
                filter: brightness(1.5);
            }
            50% {
                opacity: 1;
                transform: scale(1) rotate(180deg);
                filter: brightness(2);
            }
            75% {
                opacity: 0.8;
                transform: scale(1.2) rotate(270deg);
                filter: brightness(1.5);
            }
            100% {
                opacity: 0;
                transform: scale(1.8) rotate(360deg);
                filter: brightness(1);
            }
        }

        .side-panel {
            flex: 0 0 auto;
            width: 304px;
            min-width: 200px;
            max-width: 400px;
            height: 100%;
            background-color: #FFFFFF;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            display: flex;
            position: relative;
            box-sizing: border-box;
        }

        .panel-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            border-radius: inherit;
            display: block;
        }

        .text-content {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
            padding: 40px;
            pointer-events: none;
        }

        .text-content p {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-weight: 600;
            font-size: 18px;
            line-height: 1.4;
            letter-spacing: -0.02em;
            color: #191919;
            text-align: left;
            margin: 0;
            width: 100%;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 1024px) {
            .side-panel {
                min-width: 150px;
                width: auto;
            }
        }

        /* === Activity4B: line matching cards and handles === */

        .match-stage {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .match-grid {
            display: grid;
            grid-template-columns: repeat(2, 220px);
            grid-auto-rows: 150px;
            column-gap: 160px;
            row-gap: 72px;
            align-items: center;
            justify-items: center;
        }

        .card {
            position: relative;
            width: 190px;
            height: 150px;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(6px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            z-index: 3; /* cards above lines */
        }

        .card-inner {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .card-inner img {
            width: auto;
            height: auto;
            max-width: 75%;
            max-height: 75%;
            object-fit: contain;
            display: block;
            margin: auto;
        }

        /* Invisible hit area */
        .card-handle {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            
            width: 72px;   /* BIG tap area */
            height: 72px;
            
            background: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        /* Visible dot (unchanged size) */
        .card-handle .handle-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            
            width: 32px;
            height: 32px;
            border-radius: 50%;
            
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.20);
            
            pointer-events: none; /* important */
            animation: dotPulse 1.6s ease-in-out infinite;
        }

        /* Optional press feedback (feels nice for kids) */
        .card-handle:active .handle-dot {
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* Stop pulsing once a handle is connected */
        .card-handle.connected .handle-dot {
            animation: none !important;
        }

        .card-handle.hover-target .handle-dot {
            box-shadow: 0 0 0 6px rgba(244,200,64,0.35), 0 6px 14px rgba(0,0,0,0.25);
            animation: none !important;
        }

        /* Position the 72px hit area so its CENTER aligns where the old 32px dot used to be */
        .card-left .card-handle  { right: -36px; }  /* - (72/2) */

        .card-right .card-handle { left: -36px; }   /* - (72/2) */

        /* Micro ghost hint — teaches "drag from here", not the answer */
        .micro-ghost {
            position: absolute;
            top: 50%;
            width: 14px;          /* smaller than before */
            height: 4px;
            background: rgba(244, 200, 64, 0.8);
            border-radius: 2px;
            transform: translateY(-50%);
            opacity: 0;
            pointer-events: none;
            animation: microGhostPulse 3s ease-in-out infinite;
        }

        /* Attach micro-ghost to DOT edge (dot is centered at 50%, radius ~16px) */
        .card-left .micro-ghost {
            left: calc(50% + 16px);     /* start at dot edge */
        }

        .card-right .micro-ghost {
            left: calc(50% - 16px - 14px); /* 14px = micro-ghost width */
        }

        @keyframes microGhostPulse {
            0%   { opacity: 0; }
            20%  { opacity: 0.8; }
            50%  { opacity: 0.8; }
            80%  { opacity: 0; }
            100% { opacity: 0; }
        }

        @keyframes dotPulse {
            0%   { transform: translate(-50%, -50%) scale(1); }
            50%  { transform: translate(-50%, -50%) scale(1.12); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .card-connected {
            transform: scale(1.03);
            box-shadow:
                0 0 0 3px rgba(244, 200, 64, 0.95),
                0 8px 16px rgba(0, 0, 0, 0.18);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .connection-layer {
            position: absolute;
            inset: 0;
            overflow: visible;
            pointer-events: none;
            z-index: 2; /* lines above background but below cards */
        }

        .connection-line {
            fill: none;
            stroke: #f4c840;
            stroke-width: 6;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
            transition: stroke-width 0.2s ease-out, opacity 0.2s ease-out;
        }

        .connection-line.active {
            opacity: 0.9;
        }

        .connection-line.connected {
            stroke-width: 7;
        }

        @keyframes linePulse {
            0%   { stroke-width: 7; }
            50%  { stroke-width: 10; }
            100% { stroke-width: 7; }
        }

        .connection-line.pulse {
            animation: linePulse 0.25s ease-out;
        }
    </style>

    <!-- Standard Favicons -->
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/x-icon" href="images/favicon/favicon.ico">

    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="images/favicon/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="images/favicon/android-chrome-512x512.png">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="images/favicon/apple-touch-icon.png">
</head>
<body class="fade-start">
    <div class="activity-page">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <img src="images/eMi Logo.svg" alt="eMi logo" class="logo-image" />
            <div class="toolbar-actions">
                <button class="tool-action" onclick="fadeNavigate('Activity1B.html')">1</button>
                <button class="tool-action" onclick="fadeNavigate('Activity2B.html')">2</button>
                <button class="tool-action" onclick="fadeNavigate('Activity3B.html')">3</button>
                <button class="tool-action active" onclick="fadeNavigate('Activity4B.html')">4</button>
                <button class="tool-action" onclick="fadeNavigate('Activity5B.html')">5</button>
            </div>
            <button class="back-button" aria-label="Go back" onclick="fadeNavigate('index.html');">
                <img src="images/back-icon.svg" alt="Back" class="back-icon" />
            </button>
        </div>

        <!-- Middle Panel - Line Matching Game -->
        <div class="main-panel">
            <img src="images/Mascot-side2b.jpg" class="forest-bg" alt="Forest background" />
            <div class="match-stage" id="match-stage">
                <svg class="connection-layer" id="connection-layer"></svg>

                <div class="match-grid">
                    <!-- Row 1 -->
                    <div class="card card-left" data-id="elephant">
                        <div class="card-inner">
                            <img src="images/elephant.png" alt="Elephant">
                        </div>
                        <button class="card-handle" type="button" aria-label="Connect elephant">
                            <span class="handle-dot"></span>
                            <span class="micro-ghost"></span>
                        </button>
                    </div>

                    <div class="card card-right" data-id="icecream">
                        <div class="card-inner">
                            <img src="images/icecream.png" alt="Ice cream">
                        </div>
                        <button class="card-handle" type="button" aria-label="Connect ice cream">
                            <span class="handle-dot"></span>
                            <span class="micro-ghost"></span>
                        </button>
                    </div>

                    <!-- Row 2 -->
                    <div class="card card-left" data-id="rabbit">
                        <div class="card-inner">
                            <img src="images/rabbit.png" alt="Rabbit">
                        </div>
                        <button class="card-handle" type="button" aria-label="Connect rabbit">
                            <span class="handle-dot"></span>
                            <span class="micro-ghost"></span>
                        </button>
                    </div>

                    <div class="card card-right" data-id="mouse">
                        <div class="card-inner">
                            <img src="images/mouse.png" alt="Mouse">
                        </div>
                        <button class="card-handle" type="button" aria-label="Connect mouse">
                            <span class="handle-dot"></span>
                            <span class="micro-ghost"></span>
                        </button>
                    </div>

                    <!-- Row 3 -->
                    <div class="card card-left" data-id="sun">
                        <div class="card-inner">
                            <img src="images/sun.png" alt="Sun">
                        </div>
                        <button class="card-handle" type="button" aria-label="Connect sun">
                            <span class="handle-dot"></span>
                            <span class="micro-ghost"></span>
                        </button>
                    </div>

                    <div class="card card-right" data-id="turtle">
                        <div class="card-inner">
                            <img src="images/turtle.png" alt="Turtle">
                        </div>
                        <button class="card-handle" type="button" aria-label="Connect turtle">
                            <span class="handle-dot"></span>
                            <span class="micro-ghost"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Mascot Illustration -->
        <div class="side-panel">
            <img src="images/Mascot-side.jpg" class="panel-image" alt="Mascot" />
            <div class="text-content">
                <p>Can you find what's opposite?</p>
                <p>Draw a line to match them!</p>
            </div>
        </div>
    </div>

    <script>
        // Fade in on page load
        window.addEventListener('load', () => {
            document.body.classList.remove('fade-start');
        });

        // Helper for fade + navigate
        function fadeNavigate(url) {
            document.body.classList.add('fade-out');
            setTimeout(() => {
                window.location.href = url;
            }, 150);
        }

        // ===== Activity4B: matching lines (free connections) =====

        const connections = new Map(); // handle -> { leftHandle, rightHandle, path }
        let activeLine = null;
        let activeSourceHandle = null;
        let activeStart = null;
        let connectionLayer = null;
        let handles = [];

        let hoverTargetHandle = null;
        const SNAP_RADIUS = 60; // forgiving for kids, roughly >= hit area radius

        function setHoverTarget(next) {
            if (hoverTargetHandle === next) return;

            if (hoverTargetHandle) hoverTargetHandle.classList.remove('hover-target');

            hoverTargetHandle = next;

            if (hoverTargetHandle) hoverTargetHandle.classList.add('hover-target');
        }

        function findNearestTargetHandle(clientX, clientY, sourceHandle) {
            const pt = toSvgCoords(clientX, clientY);

            let best = null;
            let bestDist = Infinity;

            for (const h of handles) {
                if (h === sourceHandle) continue;

                // only allow left ↔ right targets
                const sourceCard = sourceHandle.closest('.card');
                const targetCard = h.closest('.card');
                const sourceIsLeft = sourceCard.classList.contains('card-left');
                const targetIsLeft = targetCard.classList.contains('card-left');
                if (sourceIsLeft === targetIsLeft) continue;

                const c = getHandleCenter(h);
                const d = Math.hypot(pt.x - c.x, pt.y - c.y);

                if (d < bestDist) {
                    bestDist = d;
                    best = h;
                }
            }

            return bestDist <= SNAP_RADIUS ? best : null;
        }

        function toSvgCoords(clientX, clientY) {
            const svgRect = connectionLayer.getBoundingClientRect();
            return {
                x: clientX - svgRect.left,
                y: clientY - svgRect.top
            };
        }

        function getHandleCenter(handle) {
            const rect = handle.getBoundingClientRect();
            return toSvgCoords(rect.left + rect.width / 2, rect.top + rect.height / 2);
        }

        function updateActiveLine(clientX, clientY) {
            if (!activeLine || !activeStart) return;
            const end = toSvgCoords(clientX, clientY);
            const midX = (activeStart.x + end.x) / 2;
            const d = `
                M ${activeStart.x} ${activeStart.y}
                Q ${midX} ${activeStart.y} ${end.x} ${end.y}
            `;
            activeLine.setAttribute('d', d);
        }

        function removeConnectionForHandle(handle) {
            const existing = connections.get(handle);
            if (!existing) return;
            const { leftHandle, rightHandle, path } = existing;
            connections.delete(leftHandle);
            connections.delete(rightHandle);
            if (path && path.parentNode) {
                path.parentNode.removeChild(path);
            }
            [leftHandle, rightHandle].forEach(h => {
                const card = h.closest('.card');
                if (card) card.classList.remove('card-connected');
                // Remove connected class to re-enable pulsing
                h.classList.remove('connected');
            });
        }

        function createConnection(leftHandle, rightHandle, fromTempPath) {
            removeConnectionForHandle(leftHandle);
            removeConnectionForHandle(rightHandle);

            const start = getHandleCenter(leftHandle);
            const end = getHandleCenter(rightHandle);
            const midX = (start.x + end.x) / 2;

            const path = fromTempPath || document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'connection-line connected pulse');
            const d = `
                M ${start.x} ${start.y}
                Q ${midX} ${start.y} ${end.x} ${end.y}
            `;
            path.setAttribute('d', d);

            if (!fromTempPath) {
                connectionLayer.appendChild(path);
            }

            const conn = { leftHandle, rightHandle, path };
            connections.set(leftHandle, conn);
            connections.set(rightHandle, conn);

            [leftHandle, rightHandle].forEach(h => {
                const card = h.closest('.card');
                if (card) card.classList.add('card-connected');
            });

            // Mark handles as connected and remove micro-ghost
            leftHandle.classList.add('connected');
            rightHandle.classList.add('connected');
            leftHandle.querySelector('.micro-ghost')?.remove();
            rightHandle.querySelector('.micro-ghost')?.remove();

            path.addEventListener('animationend', () => {
                path.classList.remove('pulse');
            }, { once: true });
        }

        function resetActive() {
            activeLine = null;
            activeSourceHandle = null;
            activeStart = null;
        }

        // Initialize after DOM is ready
        window.addEventListener('load', () => {
            connectionLayer = document.getElementById('connection-layer');
            handles = connectionLayer
                ? Array.from(document.querySelectorAll('.card-handle'))
                : [];

            if (connectionLayer && handles.length) {
                handles.forEach(handle => {
                handle.addEventListener('pointerdown', e => {
                    handle.querySelector('.micro-ghost')?.remove();
                    setHoverTarget(null); // clear any previous hover state
                    e.preventDefault();
                    activeSourceHandle = handle;

                    // --- NEW LOGIC: if this handle already has a connection, tapping removes it ---
                    const existing = connections.get(handle);
                    if (existing) {
                        removeConnectionForHandle(handle);
                        activeSourceHandle = null;
                        activeStart = null;
                        return;
                    }
                    // ------------------------------------------------------------------------------

                    activeStart = getHandleCenter(handle);

                    activeLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    activeLine.setAttribute('class', 'connection-line active');
                    connectionLayer.appendChild(activeLine);

                    updateActiveLine(e.clientX, e.clientY);
                    handle.setPointerCapture(e.pointerId);

                    const move = evt => {
                        updateActiveLine(evt.clientX, evt.clientY);
                        const near = findNearestTargetHandle(evt.clientX, evt.clientY, activeSourceHandle);
                        setHoverTarget(near);
                    };

                    const up = evt => {
                        handle.releasePointerCapture(evt.pointerId);
                        handle.removeEventListener('pointermove', move);
                        handle.removeEventListener('pointerup', up);
                        handle.removeEventListener('pointercancel', up);

                        const targetHandle =
                            hoverTargetHandle ||
                            (document.elementFromPoint(evt.clientX, evt.clientY)?.closest('.card-handle'));

                        if (!targetHandle || targetHandle === activeSourceHandle) {
                            if (activeLine && activeLine.parentNode) {
                                activeLine.parentNode.removeChild(activeLine);
                            }
                            setHoverTarget(null);
                            resetActive();
                            return;
                        }

                        const sourceCard = activeSourceHandle.closest('.card');
                        const targetCard = targetHandle.closest('.card');
                        const sourceIsLeft = sourceCard.classList.contains('card-left');
                        const targetIsLeft = targetCard.classList.contains('card-left');

                        // Only connect left ↔ right
                        if (sourceIsLeft === targetIsLeft) {
                            if (activeLine && activeLine.parentNode) {
                                activeLine.parentNode.removeChild(activeLine);
                            }
                            setHoverTarget(null);
                            resetActive();
                            return;
                        }

                        const leftHandle = sourceIsLeft ? activeSourceHandle : targetHandle;
                        const rightHandle = sourceIsLeft ? targetHandle : activeSourceHandle;

                        createConnection(leftHandle, rightHandle, activeLine);
                        setHoverTarget(null);
                        resetActive();
                    };

                    handle.addEventListener('pointermove', move);
                    handle.addEventListener('pointerup', up);
                    handle.addEventListener('pointercancel', up);
                });
                });
            }
        });
    </script>
</body>
</html>

